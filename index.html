<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kamera Notfall-Test</title>
    <style>
        body { 
            background-color: #330000; /* Dunkelrot = Fehler/Laden */
            color: #fff; 
            font-family: sans-serif; 
            margin: 0; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Das Video muss sichtbar sein! Keine Tricks. */
        video {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
            background: #000;
        }

        /* Log-Layer liegt ÜBER dem Video */
        #log-layer {
            position: absolute;
            top: 10px; left: 10px; right: 10px;
            z-index: 999;
            pointer-events: none;
        }

        .msg {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #fff;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 14px;
        }

        .error { border-color: #ff0000; color: #ff9999; }
        .success { border-color: #00ff00; color: #99ff99; }
        .warn { border-color: #ffff00; color: #ffff99; }

        /* Ein Button, falls Autoplay blockiert wird */
        #start-btn {
            position: absolute;
            bottom: 50px;
            z-index: 1000;
            padding: 20px 40px;
            font-size: 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            display: none; /* Erstmal verstecken */
            cursor: pointer;
        }
    </style>
</head>
<body>

    <video id="cam-video" autoplay playsinline muted></video>

    <div id="log-layer">
        <div class="msg">Initialisiere Skript...</div>
    </div>

    <button id="start-btn" onclick="startCameraManual()">KAMERA STARTEN</button>

<script>
    const logLayer = document.getElementById('log-layer');
    const video = document.getElementById('cam-video');
    const btn = document.getElementById('start-btn');

    function log(text, type = 'normal') {
        const div = document.createElement('div');
        div.className = 'msg ' + type;
        div.innerText = text;
        logLayer.appendChild(div);
        console.log(text);
    }

    // 1. Check: Läuft JS überhaupt?
    log("Schritt 1: JavaScript läuft.");

    // 2. Check: Ist die Verbindung sicher?
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        log("ACHTUNG: Seite ist nicht HTTPS! Kamera wird wahrscheinlich blockiert.", "error");
        log("Aktuelle URL: " + location.href, "warn");
    } else {
        log("Verbindung sieht sicher aus (HTTPS/Localhost).", "success");
    }

    // 3. Check: Hat der Browser die API?
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        log("FEHLER: Dein Browser unterstützt keine Kamera-API (getUserMedia fehlt).", "error");
        log("Nutzt du ein iPhone? Dann muss es Safari sein (nicht Chrome/Firefox auf iOS).", "warn");
    } else {
        log("Browser API vorhanden. Versuche Zugriff...", "success");
        attemptCameraStart();
    }

    async function attemptCameraStart() {
        try {
            // Wir versuchen erst die Rückkamera
            const constraints = { 
                audio: false, 
                video: { 
                    facingMode: 'environment', // Rückkamera
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            };

            log("Fordere Stream an (environment)...");
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            handleStream(stream);

        } catch (err) {
            log("Fehler bei Rückkamera: " + err.name + ": " + err.message, "error");
            
            // Fallback: Irgendeine Kamera
            log("Versuche Fallback (irgendeine Kamera)...", "warn");
            try {
                const streamFallback = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                handleStream(streamFallback);
            } catch (err2) {
                log("FATAL: Zugriff komplett verweigert. " + err2.message, "error");
                log("Hast du 'Zulassen' geklickt?", "warn");
                btn.style.display = "block"; // Button zeigen für manuellen Versuch
            }
        }
    }

    function handleStream(stream) {
        log("Stream erhalten! Setze Video-Source...", "success");
        video.srcObject = stream;
        
        // Warten bis Daten da sind
        video.onloadedmetadata = () => {
            log("Metadaten geladen. Versuche play()...");
            video.play().then(() => {
                log("VIDEO SOLLTE JETZT LAUFEN!", "success");
                document.body.style.backgroundColor = "#000"; // Hintergrund schwarz machen
            }).catch(e => {
                log("Autoplay blockiert: " + e.message, "error");
                btn.style.display = "block"; // Button zeigen
                btn.innerText = "KLICKEN ZUM STARTEN";
            });
        };
    }

    function startCameraManual() {
        btn.style.display = "none";
        attemptCameraStart();
    }

</script>
</body>
</html>